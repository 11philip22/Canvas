#! /usr/bin/env python


#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002
#http://www.immunityinc.com/CANVAS/ for more information


from toolbar import VisualToolbar

#for devlog() and friends
from internal import *

class Toolobject(VisualToolbar):
  NAME = "EIP"
  GLADE_DIALOG = "dialog.glade2"
  filexpm = "EIP.ico"
  button_label = "Add EIP"
  button_tooltip = "Add a EIP to exploit packet"
  button_private_tooltip = "Private"
  button_signal = None
  color = "#e0e04e"
  size = 45
  type = "random"
  NumberofXp =1
  objsize = 4
  objectcomments = None
  link=False
  version=0

  
  def __init__(self):
    VisualToolbar.__init__(self)

  def setSize(self, size):
    self.size =size
        
  def setArg(self,args):
    self.value = args['value']
    self.objsize=4
    if args['littleendian'] == True:
      self.type = "Little Endian"
    else:
      self.type = "Big Endian"
    #set the zeroth target to our value (the default)
    self.gui.setDefaultTarget(self.value)
    
  def setDialog(self,dialog,xpacket,badchars,arch):
    value=dialog.get_widget('value')
    littleendian=dialog.get_widget('littleendian')
    bigendian=dialog.get_widget('bigendian')
    try:
      v=int(self.value,16)
    except ValueError:
      print "Incorrect value in EIP Object"
    value.set_text(self.value)
    if self.type == "Little Endian":
      littleendian.set_active(True)
      bigendian.set_active(False)
    else:
      bigendian.set_active(True)
      littleendian.set_active(False)
      
  def Show(self):
    return "Default Value: %s\ntype: %s" % (self.value, self.type)
  
  def Help(self):
    return "The 'EIP' buffer option allows you to set a given DWORD value in your\n\
buffer in either big endian or little endian order."


  def createPython(self):
    if self.type == "Big Endian":
            return ['self.info,self.eip = targets[self.version]\n','nbuf+= big_order(self.eip)\n']
    else:
            return ['self.info,self.eip = targets[self.version]\n','buf+= intel_order(self.eip)\n']
  
  def preparedialog(self,arga,argb,argc,badchars,arch):
    pass
  
  
  def save(self):
    savedic={}
    savedic['value']=self.value
    savedic['objsize']=self.objsize
    savedic['type']=self.type
    if self.objectcomments:
      savedic['comment']=self.objectcomments.replace("\n","\\n")
    return savedic
  
  def load(self,args):
    if args.has_key('value'):
      self.value = args['value']
      
    if args.has_key('type'):
      self.type = args['type']
      
    if args.has_key('objsize'):
      self.objsize = args['objsize']
    
    if args.has_key('comment'):
      tmp = args['comment']
      self.objectcomments=tmp.replace("\\n","\n")
  
  def getDefaultTarget(self):
    return self.value
  
  def setVersion(self,default):
    self.version=default
  
