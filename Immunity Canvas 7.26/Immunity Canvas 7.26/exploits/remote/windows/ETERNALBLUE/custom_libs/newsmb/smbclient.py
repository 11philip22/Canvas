#!/usr/bin/env python
##ImmunityHeader v1
###############################################################################
## File       :  smbclient.py
## Description:
##            :
## Created_On :  Mon Jul 12 14:17:04 2010
## Created_By :  Kostya Kortchinsky
## Modified_On:  Fri Oct 22 10:47:47 2010
## Modified_By:  Kostya Kortchinsky
##
## (c) Copyright 2010, Immunity, Inc. all rights reserved.
###############################################################################

import sys
if '.' not in sys.path:
    sys.path.append('.')

from socket import socket
import libs.newsmb.libsmb as libsmb
from libs.newsmb.libsmb import GetHostnameUsingSMB
import cStringIO

USER='administrator'
PWD='barbar123!'
DOMAIN='IMMU2.COM'
TARGET='192.168.0.1'

sockaddr = (TARGET, 445)
s = socket()
s.connect(sockaddr)
u = USER
p = PWD
d = DOMAIN
smb = libsmb.SMBClient(s, u, p, d)
smb.is_unicode = True
#smb.max_smbfrag = 1
smb.negotiate()
smb.session_setup(kerberos_db='/tmp/krb5cc_1000', use_krb5=True)
#smb.session_setup(kerberos_db=None, use_krb5=True)
#smb.session_setup(use_krb5=False)
smb.tree_connect(u'C$')

target_host = GetHostnameUsingSMB(TARGET)
print "=> Listing files on %s (%s)" % (TARGET, '.'.join([target_host,DOMAIN]).upper())

files = smb.dir(u'\\*')
for f in files:
    print f['FileName']

smb.tree_disconnect()
smb.logoff()

#f = file('./get.test', 'wb')
#smb.get(u'\\cygnusfe.zip', f)
#f.close()

#f = file('./smallget.test', 'wb')
#smb.get(u'\\smallfile.txt', f)
#f.close()

#f = cStringIO.StringIO()
#f.write('A'*0x40000)
#smb.put(f, u'\\get.test')
#f.close()
#