#! /usr/bin/env python

#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002-2015
#http://www.immunityinc.com/CANVAS/ for more information

import sys
if "." not in sys.path:
    sys.path.append(".")

import os, getopt, string
import socket
import locale
from tempfile import NamedTemporaryFile
from exploitutils import *
import logging
from canvasexploit import canvasexploit
from ExploitTypes.localcommand import LocalCommand

import canvasengine

NAME                            = "ad_getlocaladmins"
DESCRIPTION                     = "Use ADSI via a PowerShell node to retrieve a system's local group membership info"
VERSION                         = "1.0"

DOCUMENTATION                   = {}
DOCUMENTATION["Notes"]          = "The command retrurns the account name, account type, last login and group. This module will only work on a PowerShell Node"
DOCUMENTATION["Commandline"]    = "runmodule ad_getlocalusers  -O computer:targethost"

PROPERTY                        = {}
PROPERTY['TYPE']                = "Commands"
PROPERTY['SITE']                = "Local"
PROPERTY['ARCH']                = [ ["Windows"] ]


class theexploit(LocalCommand):
    def __init__(self):
        LocalCommand.__init__(self)
        self.result         = ""
        self.computer       = ""
        return

    def getargs(self):
        self.computer     = self.argsDict.get("computer", self.computer)

    def run(self):
        self.getargs()
        self.setInfo("%s (in progress)" % (NAME))
        ret = False
        for node in self.argsDict["passednodes"]:
            ntype = node.nodetype
            shell = node.shell
            if ntype == "PowerShellNode" or ntype in ['win32Node', 'win64Node']:
                tfile  = file_utf8_encoding( open( os.path.abspath(os.path.join(os.path.dirname(__file__), "Resources/", "getLocalUsers.ps1")), "rb").read() )
                tfile  = tfile.replace("HELLOCOMPUTER", str(self.computer))
                runpow = canvasengine.getModuleExploit("runpowershellscript")
                runpow.link(self)
                runpow.argsDict["PSBuffer"]   = tfile
                runpow.argsDict["copytodisk"] = False
                ret = runpow.run()
                users = []
                for a in runpow.result.replace("\r\n", "").split("***"):
                    a = string.strip(a)
                    if a:
                        users += [ a.split("@##@") ]
                self.result = users
                self.setInfo("%s - done (success)" % NAME)
                return True
        else:
            logging.info("Node (%s) not supported" % ntype)
            self.setInfo("%s - done (failed)" % NAME)

        return ret