#! /usr/bin/env python
#Proprietary CANVAS source code - use only under the license agreement
#specified in LICENSE.txt in your CANVAS distribution
#Copyright Immunity, Inc, 2002-2004
#http://www.immunityinc.com/CANVAS/ for more information

import sys
#covers both angles
if "." not in sys.path:
    sys.path.append(".")

import os,getopt
import socket
from exploitutils import *
import canvasengine
import time

from ExploitTypes.localcommand import LocalCommand

NAME                   = "setuid"
DESCRIPTION            = "Sets the user ID on Unix-family systems"
DOCUMENTATION          = {}
DOCUMENTATION["CVE"]   = "N/A"
DOCUMENTATION["Notes"] = """

If you have used the "whoami" module on Linux you may have noticed
that your UID is non-zero but your EUID is zero. This module
calls "setuid()" to set your UID to whatever you would like (0, most likely).

It does this on all selected nodes.
"""

VERSION                = "1.0"
PROPERTY               = {}
PROPERTY['TYPE']       = "Commands"
PROPERTY['SITE']       = "Local"
PROPERTY['ARCH']       = [ ["Unix"] ]


class theexploit(LocalCommand):
    def __init__(self):
        LocalCommand.__init__(self)
        self.result=""
        self.name=NAME
        self.userid=0 #root by default

    def getArgs(self):
        self.getarg("userid")

    def run(self):
        self.setInfo("%s (in progress)"%(NAME))
        node=self.argsDict["passednodes"][0]

        self.result=[]
        for node in self.argsDict["passednodes"]:
            nodetype=node.nodetype
            capabilities=node.capabilities
            if "posix" in capabilities:
                ret=node.shell.setuid(self.userid)
                if ret!=-1:
                    self.log("Node %s was able to setuid to %s!"%(node.get_name(), self.userid))
                    self.result+=[1]
                else:
                    self.log("Node %s was not able to setuid to %s!"%(node.get_name(), self.userid))
                    self.result+=[0]
            else:
                self.log("The node named %s of type %s does not have the (posix) capabilities needed to run this command"%(node.get_name(),nodetype))
                self.result+=[0]

        if 1 in self.result:
            ret=1
        else:
            ret=0
        self.setInfo("%s - done"%(NAME))
        return ret

