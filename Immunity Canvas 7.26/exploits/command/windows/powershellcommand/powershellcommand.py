#! /usr/bin/env python

# Proprietary CANVAS source code - use only under the license agreement
# specified in LICENSE.txt in your CANVAS distribution
# Copyright Immunity, Inc, 2002-2004
# http://www.immunityinc.com/CANVAS/ for more information

import sys
import base64
if "." not in sys.path:
    sys.path.append(".")


import os,getopt
from exploitutils import *

from ExploitTypes.localcommand import LocalCommand
import logging

NAME             = "PowerShell Command"
DESCRIPTION      = "Send a PowerShell command"
DOCUMENTATION    = {}
VERSION          = "1.0"
GTK2_DIALOG      = "dialog.glade2"


PROPERTY         = {}
PROPERTY['TYPE'] = "Commands"
PROPERTY['SITE'] = "Local"
PROPERTY['ARCH'] = [ ["Windows"] ]


class theexploit(LocalCommand):
    def __init__(self):
        LocalCommand.__init__(self)
        self.result     = ""
        self.command    = "pwd"
        self.name       = NAME

    def getargs(self):
        self.command = self.argsDict.get("PCommand", self.command)

    def run(self):
        self.getargs()
        self.setInfo("%s (in progress)" % (NAME))
        for node in self.argsDict["passednodes"]:
            ntype = node.nodetype
            shell = node.shell
            if ntype == "PowerShellNode":
                self.result += shell.runcommand(self.command, True)
            elif ntype in ['win32Node', 'win64Node']:
                encodedCommand = base64.b64encode(self.command.encode('UTF-16LE'))
                self.result += shell.runcommand('echo ""|powershell.exe -encodedCommand {}'.format(encodedCommand))
            else:
                self.setInfo("%s - done (failed: Node not supported)" % NAME)
                logging.error("Node %s not supported" % ntype)
                return 0

        logging.info("Result: %s" % self.result)
        self.setInfo("%s - done (success)" % NAME)
        #self.setInfo("%s\n" % self.result)

        return 1
