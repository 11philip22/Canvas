#!/usr/bin/env python
##ImmunityHeader v1
###############################################################################
## File       :  dump_ccache.py
## Description:
##            :
## Created_On :  Tue Jan  3 15:32:24 CET 2017
## Created_By :  X.
##
## (c) Copyright 2010, Immunity, Inc. all rights reserved.
###############################################################################

## Helper script to dump ccache files on Linux/Unix systems

'''
$ klist -f
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: administrator@IMMU8.COM

Valid starting       Expires              Service principal
03/01/2017 15:38:33  04/01/2017 01:38:33  krbtgt/IMMU8.COM@IMMU8.COM
	renew until 04/01/2017 15:38:29, Flags: RIA
$ python libs/kerberos/dump_ccache.py /tmp/krb5cc_1000 
INFO:root:===== HEADER =====
{'credential_headers': [{'tag': 1, 'data': '\x00\x00\x00\x00\x00\x00\x00\x00'}], 'sig': 1284, 'headerlen': 12}
===== PRIMARY PRINCIPAL =====
administrator@IMMU8.COM
===== CRED =====
{'authdata': [], 'key': {'type': 18, 'value': '\xec\xe4K\xb9\x14\xd3\x81\x9e\xdd\x0cx\x80\xa2\x06)<S\xfb="\xae\x87\xb0\x9e\xae\xd2<\xda\x87\x1a{$'}, 'times': {'endtime': 1483490313, 'authtime': 1483454313, 'starttime': 1483454313, 'renew_till': 1483540709}, 'client': {'realm': 'IMMU8.COM', 'name_type': 1, 'components': ['administrator']}, 'is_skey': 0, 'addrs': [], 'tktflags': 14680064, 'second_ticket': '', 'ticket': 'a\x82\x04#0\x82\x04\x1f\xa0\x03\x02\x01\x05\xa1\x0b\x1b\tIMMU8.COM\xa2\x1e0\x1c\xa0\x03\x02\x01\x02\xa1\x150\x13\x1b\x06krbtgt\x1b\tIMMU8.COM\xa3\x82\x03\xe90\x82\x03\xe5\xa0\x03\x02\x01\x12\xa1\x03\x02\x01\x04\xa2\x82\x03\xd7\x04\x82\x03\xd3\x95\xbd6{\xbfVS\xad\x86\xb0Rx\x92\xf8\x16|\x10\xe5\xd7\xcd\xd8\xf5\xae\xbd\x92\xf5G\x17}M\x84\x1f\x8f\x11\xe1z;3\xc7\xfa\xc3\xb2\xe2\x05M\x8c/\x1b\xdb\x88\x87\xd7\xb4\xabi;@\x83\xe6\xdcC\xe8\xbd\xc3)i\xad\\\xcb\xb6Nne \xc5=\x8c}\t`\xa3\'\x84\x88)`\x186F5S\xde\x82\xb71\xadAx-4\xf4W\x82\xd7[\x9c\x85\xe1\xe1/D\x83\xc56E\xf7\x18\'s_\x80qQ\x9d\x1b\x9d\xc4q\x16\x0c\xe3\x87\xdf\xd5\xb2\xccZ\xff\x10\xc562\x17\x9d\xe9\xc3rR(6Oc\x1e\xaf\xd1>o\x04-\xf0\x13o 8\x86;\xacYW`BT\xa7\xd3"F\xc0m\x11\\\xc8\xb8<\xc9\x16\x83\xe8\x19\x81\xdf\x96e\x03\xa8r\x13\xb92\xb1Q\x99\x0c\x9eO\xee\xbd!\x7f\xd5\x002\x0e\xdf\xbd\x1as4z\xac\xed^zv\x90~b\xa1?\xe4o\xc4\xb5\x1c\xeeB\xb3n\xf6>\xa6\xf6\x05D\xfa\xce\t\x93\xcc\ndy[$\x1c\x8d/|q\x7f\xb0\'G\x9d:\xd5nP\x10\x8b\x0fa\x8b\xcb\xc8\x85\xe9\x8e]\xe6\x9a\x0b\xc7\xe3M\x99:\x98\xc8\x83ja\xb8\xa9\x90\x07\xeb_7o\x9e\x047_\xeb\xf9\xb4\xfcx\x1f-\x1d\x00Z\x0fO\xcb\xba6,L\x90\xb6\x80D\xcb\x12\x889\x8e\xd7&\xa0P-b\xaap\x89\xb4\xff1\xd2\xe2j\xd6\xe3\xed\x83t\xed\x16\x91\x89\x1f5s\x8aB.?\x9a\xe64\x8d\x93\xbb\x03\n0w\xe8\xa6"\xa1\xd0q\xeea|\xabY^\xec\xe6\xa2\x18\x7f\x89Pj\x14Bk\x8f\x08\xd3)|\xc8\xe0@\x9d\xce^\xb5\x81C\xf9iS\xf2\xee\xac\xf1A\x08\x05}\xa0\xf1\x95\xa0K\x8c\xce\x19vF\xe3b\xaa\xfa\x0b\xe9\xd5\xa1\xb2B2\xe1]\xb8\xeb\xb2\x1c\xc6\x83e\xd8\xcbv&\xd1\xdc\xfb\xa2!\xac\xdan\tr_\xc8\x06]\xaa\xcd\x03ys7/*\x11{\x10K?t\xa3\x11\x92\xado\x06M\x8c\xdbH\x1e\x08t\xc8x(]\x82\xcc~\x02\xdf _V\xf1\x11\xa4\xae\xda\x10\x94\x931bq\\8Q\x0bH\xe8\xb3*\x84\xf2\x7f\xc9\xdb\x057\xac\xed\xcb4l\xf8\xdcD\xbc~\xc2\x9atJ\xb3#\x07\xddA$g\x02\xea\x0b\xaaf\x18\xd2\x9d\x81\xf7C\x17,\xb3\xe1\x8e\x03\xd9\x16`[\x01\xd5\xa0:\xa1O\x0f\xc6\x9er\xec4\xcf\xb3T\xd6\x06\x94\x98z\xf8~\x9d?\x19V\xff\xa1\x95\xf3\n\xe0\xcby\x1c\x83\xf2\xfb_\xab\\`95\xbc}]01\r+\x83;\x88\xa6\x11\xa5"9\x87VUu\xbe\xa7\xb7\xd2Kg \x9d\xe7\xfa \x91O\xffO\xe3\xa2$\xae\xf9\xb5 ]\xac\xdd\xaaA\x84L\xb5{\xb2\x1fR!\xc4^\xa8\xfc\xa2)\xac\xee\x9d\x99`)\x08\x19{\xd0\xdc]@L\xb6:\x91\x0ep\xb9_s\xeb\xfd;\xafr\x0b\x13\x8b\xec\x83\xbf\xc5t\xee\xc1{\x83&Y\x8a^a\x87\x92\xbd\xae\xeay\x02\xd8\x82\x199\nV\'\xb6\xe0x\xea\x01\xaa\x885\xc4\x086"\x7f\xb3\x94\xd5Md\x19\xd1E\x00\x99\xf5z\xd9\xdaL\xf7\xd6\x9b,\xfe+\x81\x9b\xc3s\x95\x01\x9b5[\x1djkl\xee\xa11\x9e\xf1\x06\xa0R\xb8\xf5\xda\xb4\xe8b\xdeH\xcc\x062n\xf3\x15T\xce\x9c\xd8\x89\xb7\x8a9Z\xb8w\xd4\xc9I\xee\xc7\xcdq\xc9\xc8x\xe8=\xc6\xf9\xf7)\x84_v\rB:\xb2M5w\xd8cm\xd8\xe6@\x14\x1c\x953\x00S\n\nk`\xfe\xb5\xa2\xa8\x9b\xf5#\x92\x80\xfa\xec\xc8f\x92X\\2\x17\xc6\xc2\x82S.\xf1d\xd4E\xcda\xa9\xf4%\x9b\xaf\x13WC\xb9V\xc0\xe38g\x82\xbf\x81\xde}\x95\xab\x987iO\xd2-\xe8\xc06\xe8\'U\x90\x1c\r\xbd0\xa8\xff\xac\x0b\xfd\x85\xa6\xc6\xc9\xf7\xf7\xc6|\x9a\x8e\xf0\x0f\xf8P\x0b\x87T\x18\xea\x8b\xa7D"\xaf\xdd\xb7\xbc\x04`#\xd9;\xda\xb5\xba7\xd5*\x83\x89\xc3\xeb\x01F\x98c\x19\xce\xf1\xdf', 'server': {'realm': 'IMMU8.COM', 'name_type': 2, 'components': ['krbtgt', 'IMMU8.COM']}}
===== CRED =====
{'authdata': [], 'key': {'type': 0, 'value': ''}, 'times': {'endtime': 0, 'authtime': 0, 'starttime': 0, 'renew_till': 0}, 'client': {'realm': 'IMMU8.COM', 'name_type': 1, 'components': ['administrator']}, 'is_skey': 0, 'addrs': [], 'tktflags': 0, 'second_ticket': '', 'ticket': '2', 'server': {'realm': 'X-CACHECONF:', 'name_type': 0, 'components': ['krb5_ccache_conf_data', 'pa_type', 'krbtgt/IMMU8.COM@IMMU8.COM']}}
'''

import sys
import logging

if "." not in sys.path:
    sys.path.append(".")

from ccache import CCache

###
# Main to test the class!
###

def dump_ccache(b):
    try:
        cc1 = CCache()
        cc1.set_raw_data(b)
        cc1.show()
    except Exception as e:
        logging.error("Parsing error: %s" % str(e))

def main():

    logging.basicConfig(level=logging.DEBUG)

    if len(sys.argv) < 2:
        logging.error('Please specify a ccache file!')
        return

    try:
        f = open(sys.argv[1])
        b = f.read()
        f.close
    except Exception as e:
        logging.error("open() failed: %s" % str(e))
        return
    else:
        dump_ccache(b)


if __name__ == "__main__":
    main()
